<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#eccc68" />
    <meta name="msapplication-navbutton-color" content="#eccc68" />
    <meta name="apple-mobile-web-app-status-bar-style" content="#eccc68" />
    <meta
      name="description"
      content="Duolingo's Japanese language learning visualizer"
    />

    <!-- CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />

    <!-- Title -->
    <title>Japanese Duolingo Visualizer</title>
  </head>

  <body>
    <main class="col-md-12 mx-auto p-3 p-md-4">
      <header>
        <h1 class="display-5 fs-1 fw-bold text-center">
          Japanese Duolingo Visualizer
        </h1>
        <h2 class="display-6 fs-2 text-center text-muted">
          日本語のDuolingo視覚化
        </h2>
        <h3 class="display-6 fs-5 text-center text-muted" id="header-username">
          User: ...
        </h3>
      </header>

      <section class="my-4">
        <div class="d-flex justify-content">
          <span class="fw-bold lead pe-2">#</span>
          <p class="fw-bold lead shadow-lg">
            <mark>About</mark>
          </p>
        </div>

        <div>
          <p>
            Visualize your Duolingo (Japanese) progress everyday with
            <kbd>Python</kbd> and <kbd>GitHub Actions</kbd>. Website is made
            with simple and reasonable <kbd>HTML</kbd>, <kbd>CSS</kbd>,
            <kbd>JavaScript</kbd>, and <kbd>Bootstrap</kbd>, hosted with
            <kbd>GitHub Pages</kbd> as a static site. Dependencies included
            within this project (for the website) are <kbd>Chart.js</kbd> and
            <kbd>Chart.js Plugin Annotation</kbd> to make intuitive and
            user-friendly graphs. Speaking of <kbd>Python</kbd>, I used
            <kbd>Requests</kbd> to perform HTTP requests and
            <kbd>Pytest</kbd> for unit-tests. For further details, please check
            the <kbd>GitHub</kbd> repository located at the end of this page.
          </p>
        </div>
      </section>

      <section class="my-4">
        <div class="d-flex justify-content">
          <span class="fw-bold lead pe-2">#</span>
          <p class="fw-bold lead shadow-lg"><mark>Experience Graph</mark></p>
        </div>

        <div>
          <p>Graph below draws your daily experience points from Duolingo.</p>
        </div>

        <article class="vh-100 position-relative">
          <canvas aria-label="Experience Graph" id="experienceGraph">
            <p>
              This is an alternative text. This essentially shows a graph of
              your experience progress.
            </p>
          </canvas>
        </article>
      </section>

      <section class="my-4">
        <div class="d-flex justify-content">
          <span class="fw-bold lead pe-2">#</span>
          <p class="fw-bold lead shadow-lg"><mark>Time Graph</mark></p>
        </div>

        <div>
          <p>Graph below draws your minutes spent per day in Duolingo.</p>
        </div>

        <article class="vh-100 position-relative">
          <canvas aria-label="Time Graph" id="timeGraph">
            <p>
              This is an alternative text. This essentially shows a graph of
              your time spent daily in Duolingo.
            </p>
          </canvas>
        </article>
      </section>

      <section class="my-4">
        <div class="d-flex justify-content">
          <span class="fw-bold lead pe-2">#</span>
          <p class="fw-bold lead shadow-lg"><mark>Sessions Graph</mark></p>
        </div>

        <div>
          <p>
            Graph below draws your number of sessions (lessons or events) taken
            per day in Duolingo.
          </p>
        </div>

        <article class="vh-100 position-relative">
          <canvas aria-label="Sessions Graph" id="sessionsGraph">
            <p>
              This is an alternative text. This essentially shows a graph of
              your number of sessions taken per day in Duolingo.
            </p>
          </canvas>
        </article>
      </section>

      <section class="my-4">
        <div class="d-flex justify-content">
          <span class="fw-bold lead pe-2">#</span>
          <p class="fw-bold lead shadow-lg"><mark>Streak Graph</mark></p>
        </div>

        <div>
          <p>Graph below draws your daily streak progress from Duolingo.</p>
        </div>

        <article class="vh-100 position-relative">
          <canvas aria-label="Streak Graph" id="streakGraph">
            <p>
              This is an alternative text. This essentially shows a graph of
              your streak progress.
            </p>
          </canvas>
        </article>
      </section>

      <footer>
        <nav class="d-flex justify-content-center">
          <code style="font-size: 10px" class="fw-lighter text-center">
            Made with &hearts;, basic web technologies, and automation &bull;
            for further details, check the
            <a
              class="link-primary"
              href="https://github.com/lauslim12/japanese-duolingo-visualizer"
              rel="noopener noreferrer"
              target="_blank"
            >
              GitHub!
            </a>
          </code>
        </nav>
      </footer>
    </main>

    <!-- Bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
      integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"
      integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK"
      crossorigin="anonymous"
    ></script>

    <!-- Chart.js -->
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"
      integrity="sha256-+8RZJua0aEWg+QVVKg4LEzEEm/8RFez5Tb4JBNiV5xA="
      crossorigin="anonymous"
    ></script>

    <!-- Chart.js Annonations -->
    <script
      src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"
      integrity="sha256-SvW8Yj0ZmdQ5mIQ3MNbLIySteN4LwcVnUT/Xq+Qw3v4="
      crossorigin="anonymous"
    ></script>

    <!-- Personal Script -->
    <script defer type="text/javascript">
      /**
       * Who doesn't love intellisense? I'll define the JSON schema of the `duolingo-progress.json` here so you can
       * enjoy the intellisense.
       *
       * @typedef Entry
       * @type {object}
       * @property {number} number_of_sessions - Number of sessions that are done in a single day.
       * @property {number} session_time - Duration of session in a single day, in seconds.
       * @property {number} streak - Current streak.
       * @property {number} xp_today - Experience points that are gained in a single day.
       *
       * @typedef Data
       * @type {Object.<string, Entry>}
       */

      /**
       * Fetches the 'database' - a JSON file consisting of Duolingo progress.
       *
       * @returns {Promise<Data>} Data consisting of Duolingo information.
       */
      async function getDataFromJSON() {
        const url = `${window.location.protocol}//${window.location.hostname}`;
        const response = await fetch(
          `${url}/japanese-duolingo-visualizer/duolingo-progress.json`
        );

        return response.json();
      }

      /**
       * Renders the experience graph.
       *
       * @param {Data} data - Parsed data.
       */
      function renderExperienceGraph(data) {
        const dates = Object.keys(data);
        const values = Object.values(data);
        const element = document.getElementById("experienceGraph");
        if (!element) return null;

        return new Chart(element, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                backgroundColor: "rgba(46, 204, 113, 0.5)",
                borderColor: "rgba(46, 204, 113, 1.0)",
                borderWidth: 2,
                data: values.map((value) => value.xp_today),
                fill: true,
                label: "XP Gained",
                pointBackgroundColor: "rgba(52, 152, 219, 1.0)",
                pointRadius: 5,
                pointStyle: "star",
                tension: 0,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              annotation: {
                annotations: {
                  average: {
                    type: "line",
                    borderColor: "rgba(0, 0, 0, 1)",
                    borderDash: [6, 6],
                    borderDashOffset: 0,
                    borderWidth: 2,
                    label: {
                      display: true,
                      content: `Average: ${(
                        values.reduce(
                          (previous, current) => previous + current.xp_today,
                          0
                        ) / values.length
                      ).toFixed(2)} XP`,
                      position: "center",
                    },
                    scaleID: "y",
                    value:
                      values.reduce(
                        (previous, current) => previous + current.xp_today,
                        0
                      ) / values.length,
                  },
                  lower: {
                    type: "line",
                    borderColor: "rgba(232, 67, 147, 1.0)",
                    borderRadius: 10,
                    borderWidth: 2,
                    label: {
                      backgroundColor: "rgba(232, 67, 147, 1.0)",
                      display: true,
                      content: `Min: ${Math.min(
                        ...values.map((value) => value.xp_today)
                      )} XP`,
                      position: "start",
                    },
                    scaleID: "y",
                    value: Math.min(...values.map((value) => value.xp_today)),
                  },
                  upper: {
                    type: "line",
                    borderColor: "rgba(253, 121, 168, 1.0)",
                    borderRadius: 10,
                    borderWidth: 2,
                    label: {
                      backgroundColor: "rgba(232, 67, 147, 1.0)",
                      display: true,
                      content: `Max: ${Math.max(
                        ...values.map((value) => value.xp_today)
                      )} XP`,
                      position: "start",
                    },
                    scaleID: "y",
                    value: Math.max(...values.map((value) => value.xp_today)),
                  },
                },
              },
              title: {
                display: true,
                text: "Experience Points (XP) Graph",
              },
              tooltip: {
                intersect: false,
              },
              subtitle: {
                display: true,
                text: "Daily generation of XPs compared with your daily goal.",
              },
            },
          },
        });
      }

      /**
       * Renders the time graph.
       *
       * @param {Data[]} data - Parsed data.
       */
      function renderTimeGraph(data) {
        const dates = Object.keys(data);
        const values = Object.values(data);
        const element = document.getElementById("timeGraph");
        if (!element) return null;

        // Some calculations are hard to read if it's inlined, so I decided to write
        // them here, these variables are used when we want to make a line/average
        // label.
        const totalMinutes = (
          values.reduce(
            (previous, current) => previous + current.session_time / 60, // In minutes.
            0
          ) / values.length
        ).toFixed(2);
        const totalHours = Math.floor(totalMinutes / 60).toFixed(2);

        return new Chart(element, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                backgroundColor: "rgb(255, 248, 10, 0.5)",
                borderColor: "rgb(254, 177, 57, 1.0)",
                borderWidth: 2,
                data: values.map(
                  (value) => (value.session_time / 60).toFixed(2) // This is in minutes for easier calculation.
                ),
                fill: true,
                label: "Session Time (Minutes)",
                pointBackgroundColor: "rgb(41, 52, 98, 1.0)",
                pointRadius: 5,
                pointStyle: "circle",
                tension: 0,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              annotation: {
                annotations: {
                  average: {
                    type: "line",
                    borderColor: "rgba(0, 0, 0, 1)",
                    borderDash: [6, 6],
                    borderDashOffset: 0,
                    borderWidth: 2,
                    label: {
                      display: true,
                      content: `Average: ${totalHours} hour(s) ${totalMinutes} minute(s)`,
                      position: "center",
                    },
                    scaleID: "y",
                    value: (
                      values.reduce(
                        (previous, current) =>
                          previous + current.session_time / 60, // This is in minutes for easier line calculation.
                        0
                      ) / values.length
                    ).toFixed(2),
                  },
                },
              },
              title: {
                display: true,
                text: "Time Graph",
              },
              tooltip: {
                intersect: false,
                callbacks: {
                  // Display a useful, human-friendly format in 'Hours/Minutes'.
                  afterLabel: function (context) {
                    const parsedHour =
                      Number.parseInt(context.formattedValue, 10) / 60;
                    const shownHours = Math.floor(parsedHour);
                    const shownMinutes = Math.round(
                      (parsedHour - shownHours) * 60
                    );

                    return `Session Time (Hours/Minutes): ${shownHours} hour(s) ${shownMinutes} minute(s)`;
                  },
                },
              },
              subtitle: {
                display: true,
                text: "Showcases your daily time spent (in minutes) in Duolingo.",
              },
            },
          },
        });
      }

      /**
       * Renders the sessions graph.
       *
       * @param {Data[]} data - Parsed data.
       */
      function renderSessionsGraph(data) {
        const dates = Object.keys(data);
        const values = Object.values(data);
        const element = document.getElementById("sessionsGraph");
        if (!element) return null;

        return new Chart(element, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                backgroundColor: "rgb(125, 157, 156, 0.5)",
                borderColor: "rgb(239, 91, 12, 1.0)",
                borderWidth: 2,
                data: values.map((value) => value.number_of_sessions),
                fill: true,
                label: "Number of Sessions",
                pointBackgroundColor: "rgb(242, 223, 58, 1.0)",
                pointRadius: 5,
                pointStyle: "circle",
                tension: 0,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              annotation: {
                annotations: {
                  average: {
                    type: "line",
                    borderColor: "rgba(0, 0, 0, 1)",
                    borderDash: [6, 6],
                    borderDashOffset: 0,
                    borderWidth: 2,
                    label: {
                      display: true,
                      content: `Average: ${(
                        values.reduce(
                          (previous, current) =>
                            previous + current.number_of_sessions,
                          0
                        ) / values.length
                      ).toFixed(2)} session(s)`,
                      position: "center",
                    },
                    scaleID: "y",
                    value:
                      values.reduce(
                        (previous, current) =>
                          previous + current.number_of_sessions,
                        0
                      ) / values.length,
                  },
                },
              },
              title: {
                display: true,
                text: "Sessions Graph",
              },
              tooltip: {
                intersect: false,
              },
              subtitle: {
                display: true,
                text: "Showcases your number of daily sessions taken in Duolingo.",
              },
            },
          },
        });
      }

      /**
       * Renders the streak graph.
       *
       * @param {Data[]} data - Parsed data.
       */
      function renderStreakGraph(data) {
        const dates = Object.keys(data);
        const values = Object.values(data);
        const element = document.getElementById("streakGraph");
        if (!element) return null;

        return new Chart(element, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                backgroundColor: "rgb(0, 215, 255, 0.5)",
                borderColor: "rgb(0, 150, 255, 1.0)",
                borderWidth: 2,
                data: values.map((value) => value.streak),
                fill: true,
                label: "Number of Streak",
                pointBackgroundColor: "rgb(88, 0, 255, 1.0)",
                pointRadius: 5,
                pointStyle: "rectRot",
                tension: 0,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Streak Graph",
              },
              tooltip: {
                intersect: false,
              },
              subtitle: {
                display: true,
                text: "Showcases your streak information per day.",
              },
            },
          },
        });
      }

      /**
       * Renders a personalized username at the header. This is intentional to give a sense
       * of ownership.
       */
      function renderHeader() {
        const element = document.getElementById("header-username");
        if (!element) return;

        const username = window.location.host.split(".")[0];
        element.textContent = `User: @${username}`;

        return null;
      }

      /**
       * Bootstraps the whole DOM and renders the graphs for you. These functions are
       * not pure and side effects are to be expected: network JSON request and several DOM rendering
       * processes. We make sure that `data` exists to prevent unwanted errors.
       */
      async function bootstrap() {
        const data = await getDataFromJSON();
        if (!data) return null;

        // Delegate to other functions after we are sure that `data` variable exists properly and would not
        // throw any obscure errors.
        renderExperienceGraph(data);
        renderTimeGraph(data);
        renderSessionsGraph(data);
        renderStreakGraph(data);
        renderHeader();

        return null;
      }

      /**
       * Runner.
       */
      bootstrap()
        .then(() => {
          console.log("Website has finished rendering your Duolingo data.");
        })
        .catch((err) => {
          console.error("An error ocurred. Please refresh the page!");
          console.error(err);
        });
    </script>
  </body>
</html>
